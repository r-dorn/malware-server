package mongo

import (
	"context"
	"errors"
	"log"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
	"server.com/src/config"
)

var col mongo.Collection

func ConnectDatabase(dbSettings config.Settings) {
	client, err := mongo.Connect(context.TODO(), options.Client().ApplyURI(
		dbSettings.Mongodb.Connection,
	))
	if err != nil {
		log.Fatal(err)
	}
	col = *client.Database(dbSettings.Mongodb.Database).Collection(dbSettings.Mongodb.Collection)
}

func documentExists(query bson.D) bool {
	amount, err := col.CountDocuments(context.TODO(), query, options.Count().SetLimit(1))
	return amount == 1 && err == nil
}

func FindByQuery[T any](query bson.D) (T, error) {
	var decodedDocument T

	if !documentExists(query) {
		return *new(T), errors.New("no documents matching provided query")
	}
	err := col.FindOne(context.TODO(), query).Decode(&decodedDocument)
	if err != nil {
		return *new(T), err
	}
	return decodedDocument, nil
}

func Find[T any](id string) (T, error) {
	var result T

	if !documentExists(bson.D{{Key: "_id", Value: id}}) {
		return *new(T), errors.New("id does not exist")
	}
	err := col.FindOne(context.TODO(), bson.D{{Key: "_id", Value: id}}).Decode(&result)
	return result, err
}

func InsertDocument[T any](document T, existingQuery bson.D) (string, error) {
	if documentExists(existingQuery) {
		return "", errors.New("cannot insert conflicting document")
	}
	result, err := col.InsertOne(context.TODO(), document)
	return result.InsertedID.(string), err
}

func UpdateDocument[FieldType any](query bson.D, targetField string, value FieldType) error {
	if !documentExists(query) {
		return errors.New("no documents matching query")
	}
	return col.FindOneAndUpdate(context.TODO(), query, bson.D{{
		Key:   targetField,
		Value: value,
	}}).Err()
}

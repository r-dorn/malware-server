package redis

import (
	"context"
	"fmt"
	"time"

	"github.com/go-redis/redis/v8"
	"github.com/nitishm/go-rejson/v4"
	_ "github.com/nitishm/go-rejson/v4"
	"server.com/src/config"
)

var Database redis.Client
var jsonHandler rejson.Handler

func init() {
	conf := config.Load[config.Settings]()
	Database = *redis.NewClient(&redis.Options{
		Addr:     fmt.Sprintf("%s:%d", conf.Redis.RedisConnection, conf.Redis.RedisPort),
		DB:       conf.Redis.RedisDatabase,
		Username: conf.Redis.Username,
		Password: conf.Redis.Password,
	})
	t := rejson.NewReJSONHandler()
	t.SetGoRedisClient(&Database)
	jsonHandler = *t
}

func InsertJson[T any](id string, jsonData T, ttl time.Duration) error {

	_, err := jsonHandler.JSONSet(id, ".", jsonData)
	return err
}

func InsertTTL[T any](id string, document T, ttl time.Duration) error {
	err := Database.Set(context.TODO(), id, document, ttl)
	return err.Err()
}

func GetString(key string) string {
	foundDocument := Database.Get(context.TODO(), key)
	value, err := foundDocument.Result()
	if err != nil {
		return ""
	}
	return value
}

func Exists(key string) bool {
	val, err := Database.Exists(context.TODO(), key).Result()
	return val > 0 && err == nil
}

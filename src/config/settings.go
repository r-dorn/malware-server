package config

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"os"
)

const SETTINGS_ENV string = "DB_SETTINGS"

var DATABASE_SETTINGS Settings

func init() {
	DATABASE_SETTINGS = Load[Settings]()
	fmt.Println(DATABASE_SETTINGS)
}

type Settings struct {
	Mongodb struct {
		Connection string
		Collection string
		Database   string
	}
	Redis struct {
		RedisConnection string
		RedisPort       int
		RedisDatabase   int
		Username        string
		Password        string
	}
	CookieSecret string
    IpcConnection string
}

func Load[T any]() (result T) {

	path := os.Getenv(SETTINGS_ENV)

	if path == "" {
		log.Fatalf("Please set %s", SETTINGS_ENV)
	}
	if _, err := os.Stat(path); os.IsNotExist(err) {
		log.Fatalf("please point %s to a valid path", SETTINGS_ENV)
	}
	data, err := ioutil.ReadFile(path)
	if err != nil {
		log.Fatal(err)
	}
	if err := json.Unmarshal(data, &result); err != nil {
		log.Fatal(err)
	}
	return result
}

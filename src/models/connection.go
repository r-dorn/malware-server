package models

import (
	"crypto/hmac"
	"crypto/rand"
	"crypto/sha256"
	"encoding/base64"
	"encoding/json"
	"time"

	"github.com/google/uuid"
)

const DEFAULT_TTL time.Duration = time.Minute * 5 /*
	bot has 5 minutes to connect  or it will have to request a new one via GEN_NEW_CODE*/

type ConnectionKey struct {
	Ttl             time.Duration
	IssuedAt        time.Time
	AuthCode        string
	ConnectionKeyID string
	OwnedBy         string
}

func GenerateConnectionKey(userID string, codeLen int, ttl time.Duration) (ConnectionKey, error) {
	generatedBytes := make([]byte, codeLen)
	if _, err := rand.Read(generatedBytes); err != nil {
		return ConnectionKey{}, err
	}

	return ConnectionKey{
		Ttl:             ttl,
		IssuedAt:        time.Now(),
		AuthCode:        string(generatedBytes),
		ConnectionKeyID: uuid.NewString(),
	}, nil
}

func CalcuateConnectionKeyHmac(secret []byte, connectionKey ConnectionKey) (string, error) {
	JsonBytes, err := json.Marshal(connectionKey)
	if err != nil {
		return "", err
	}
	mac := hmac.New(sha256.New, secret)
	_, err = mac.Write(JsonBytes)
	if err != nil {
		return "", err
	}
	generatedHmac := mac.Sum(nil)
	return base64.RawStdEncoding.EncodeToString(generatedHmac), nil
}
